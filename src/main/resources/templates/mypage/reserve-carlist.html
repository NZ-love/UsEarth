<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="/css/mypage/reserve-carlist.css">
    <title>차량등록현황</title>
</head>
<body>
<div id="app">
    <div class="titleTop">
        <div class="headerContainer">
            <div class="headerWrapper">
                <div class="topBar">
                    <div class="application newGrid container" style="background-color: inherit">
                        <div class="application newRow">
                            <div class="application newCol1 newCol2">
                                <div class="topBarContainer">
                                    <div class="topBarBackward">
                                        <svg data-v-bd9f2bcc="" data-v-09aeb421="" width="24" height="24" viewBox="0 0 24 24" fill="black" xmlns="http://www.w3.org/2000/svg" class="image0 pointer iconLink application icon0" data-v-59015b26="" style="fill: rgb(60, 65, 68);"><path data-v-bd9f2bcc="" fill-rule="evenodd" clip-rule="evenodd" d="M4.21913 11.3753C3.92696 11.7405 3.92696 12.2595 4.21913 12.6247L8.21913 17.6247C8.56414 18.056 9.19343 18.1259 9.62469 17.7809C10.056 17.4359 10.1259 16.8066 9.78087 16.3753L6.28062 12L9.78087 7.6247C10.1259 7.19344 10.056 6.56415 9.62469 6.21914C9.19343 5.87413 8.56414 5.94405 8.21913 6.37531L4.21913 11.3753Z"></path><path data-v-bd9f2bcc="" fill-rule="evenodd" clip-rule="evenodd" d="M20 12C20 11.4477 19.5523 11 19 11H6C5.44771 11 5 11.4477 5 12C5 12.5523 5.44771 13 6 13H19C19.5523 13 20 12.5523 20 12Z"></path></svg>
                                        <div class="topTitle application typography body1" style="color: rgb(4,5,5); font-weight: 500;">등록 현황</div>
                                    </div>
                                    <div class="topBarContent">
                                        <div class="flex alignCenter">
                                            <ul class="flex inform3 headerInfoSectionList">
                                                <a href="/mypage/reserve-car">
                                                <button type="button" class="application cButton applyView medium primary full fill">
                                                    <div class="cButtonIcon"></div>
                                                    <div class="application typography body1 semiBold" style="color: inherit;">신청하기</div>
                                                    <div class="cButtonIcon"></div>
                                                </button>
                                                </a>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="fakeHeader noSub"></div>
             </div>
            <hr class="application divider line horizontal my12" style="border-color: rgb(243,244,245)">
            <div class="application newCol1 myPageCommunity newColSm4 newCol1g12 noGutters">
<!--                <div>-->
<!--                    <div class="application list myPageCommunityList">-->
<!--                        <div class="application listItem myPageCommunityListItem myPageCommunityCard medium pointer">-->
<!--                            <div class="topTitle application typography wFull body2" style="color: rgb(173,179,184);">-->
<!--                                <div class="application typography myPageCommunityListItemTitle body3" style="color: rgb(60,65,68)">방문목적:-->
<!--                                <span class="purpose">수리</span>-->
<!--                                    <div class="topTitle flex alignItemsCenter">-->
<!--                                        <div class="application typography caption1 semiBold" style="color: rgb(60,65,68)">-->
<!--                                            차량번호:-->
<!--                                            <span class="carNumber">000서0000</span>-->
<!--                                        </div>-->
<!--                                    </div>-->
<!--                                    <div class="topTitle flex alignItemsCenter">-->
<!--                                        <div class="application typography caption1 semiBold" style="color: rgb(60,65,68)">-->
<!--                                            차량종류:-->
<!--                                            <span class="carNumber">아반떼</span>-->
<!--                                        </div>-->
<!--                                    </div>-->
<!--                                    <div class="topTitle application typography myPageCommunityListItemTitle body3" style="color: rgb(60,65,68)">방문시작일:-->
<!--                                        <span class="startDate">2023/01/01</span>-->
<!--                                    </div>-->
<!--                                    <div class="topTitle application typography myPageCommunityListItemTitle body3" style="color: rgb(60,65,68)">방문종료일:-->
<!--                                        <span class="endDate">2023/01/01</span>-->
<!--                                    </div>-->
<!--                                    <div class="topTitle flex flexColumn">-->
<!--                                        <div class="topTitle application typography textRight" style="color: rgb(173,179,184);">0초 전</div>-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                                <hr class="application divider line horizontal my12" style="border-color: rgb(243,244,245)">-->
<!--                            </div>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->
            </div>
         </div>
     </div>
   </div>
</body>
<script src="/js/mypage/reserve-carlist.js"></script>
<script th:inline="javascript">
    const newColSm4 =document.querySelector(".newColSm4 ");
     // const id=[[#{session.user.id]}];
    // 페이징 밑 무한 스크롤
    let page = 1;
    let isLoading = false;
    const first=document.querySelector(".first");
    // 서버에서 데이터를 가져오는 메소드
    async function getPosts() {
        const response = await fetch(`/lists/api/reserve/1`)
        const posts = await response.json();
        return posts.reverse(); // 최신순으로 가져오도록 역순으로 정렬
    }
    function appendPost(reserve) {
        // 시간 바꾸기
        const startDate = reserve.visitBookingStartDate; // Example: "YYYY-MM-DD HH:mm:ss"
        const endDate = reserve.visitBookingEndDate;     // Example: "YYYY-MM-DD HH:mm:ss"

        const startDateParts = startDate.split(' ')[0].split('-');
        const endDateParts = endDate.split(' ')[0].split('-');

        const startDateFormatted = `${startDateParts[0]}-${startDateParts[1]}-${startDateParts[2]}`;
        const endDateFormatted = `${endDateParts[0]}-${endDateParts[1]}-${endDateParts[2]}`;

            const div = document.createElement('div');
            div.innerHTML = `
    <div>
      <div class="application list myPageCommunityList">
        <div class="application listItem myPageCommunityListItem myPageCommunityCard medium pointer">
          <div class="topTitle application typography wFull body2" style="color: rgb(173,179,184);">
            <div class="application typography myPageCommunityListItemTitle body3" style="color: rgb(60,65,68)">방문목적:
                <span class="purpose">${reserve.visitBookingPurpose}</span>
                    <div class="topTitle flex alignItemsCenter">
                        <div class="application typography caption1 semiBold" style="color: rgb(60,65,68)">
                            차량번호:
                            <span class="carNumber">${reserve.visitBookingCarNumber}</span>
                           </div>
                        </div>
                        <div class="topTitle flex alignItemsCenter">
                            <div class="application typography caption1 semiBold" style="color: rgb(60,65,68)">
                                차량종류:
                                <span class="carNumber">${reserve.visitBookingCarType}</span>
                            </div>
                        </div>
                        <div class="topTitle application typography myPageCommunityListItemTitle body3" style="color: rgb(60,65,68)">방문시작일:
                            <span class="startDate">${startDateFormatted}</span>
                        </div>
                        <div class="topTitle application typography myPageCommunityListItemTitle body3" style="color: rgb(60,65,68)">방문종료일:
                            <span class="endDate">${endDateFormatted}</span>
                        </div>
                        <div class="topTitle flex flexColumn">
                            <div class="topTitle application typography textRight" style="color: rgb(173,179,184);">${timeForToday(reserve.visitBookingRegisterDate)}</div>
                        </div>
                    </div>
                    <hr class="application divider line horizontal my12" style="border-color: rgb(243,244,245)">
                </div>
            </div>
        </div>
    </div>
   `
            newColSm4.appendChild(div);
        }

        // 한번에 보여줄 리스트의 갯수를 정하고 차츰 페이지를 증가시킨다
        function showList() {
            // 중복되어 실행되는 경우가 있어 그것을 막기위해 로딩 유무 파악
            if (isLoading) return;

            isLoading = true;
            getPosts().then((posts) => {
                const rowCount = 7;
                const offset = (page - 1) * rowCount;
                const limit = offset + rowCount;
                posts = posts.slice(offset, limit);

                if (posts.length > 0) {
                    posts.forEach((post) => {
                        appendPost(post);
                    });
                    page++;
                }
                isLoading = false;
            })
        }

        // 스크롤의 위치를 검색하고 조건에 맞춰 실행하는 함수
        function handleScroll() {
            // 현재 문서의 상단에서 스크롤바의 위치까지의 거리를 나타내는 값을 가져온다.
            const scrollTop = document.documentElement.scrollTop;
            // 현재 창의 뷰포트 높이를 나타낸다.
            const windowHeight = window.innerHeight;
            // 문서의 총 높이를 나타내는 값을 가져온다.
            const totalHeight = document.documentElement.scrollHeight;
            // 스크롤바가 문서의 아래쪽 끝에 도달했을 때 아래의 코드를 실행한다.
            if (scrollTop + windowHeight >= totalHeight - 1) {
                showList();
            }
        }

        // 스크롤 이벤트가 발생할 때마다 스크롤바의 위치를 검사하여 새로운 콘텐츠를 불러오게 된다.
        window.addEventListener("scroll", handleScroll);
        // 최초 실행하여 1페이지를 보여준다
        showList();

        function timeForToday(datetime) {
            const today = new Date();
            const date = new Date(datetime);
            let gap = Math.floor((today.getTime() - date.getTime()) / 1000 / 60);

            if (gap < 1) {
                return "방금 전";
            }

            if (gap < 60) {
                return `${gap}분 전`;
            }

            gap = Math.floor(gap / 60);

            if (gap < 24) {
                return `${gap}시간 전`;
            }

            gap = Math.floor(gap / 24);

            if (gap < 32) {
                return `${gap}일 전`;
            }

            gap = Math.floor(gap / 31);

            if (gap < 13) {
                return `${gap}개월 전`;
            }

            gap = Math.floor(gap / 12);

            return `${gap}년 전`
        }
</script>
</html>